name: GitHub Actions
on: push
jobs:
  deploy:
    runs-on: ubuntu-22.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true  
          fetch-depth: 0    

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v6

      - uses: benjlevesque/short-sha@v2.1
        if: always()
        id: short-sha
        with:
          length: 8
          
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '{"type":"service_account","project_id":"rox-cloud","private_key_id":"25c1a623b5af1f1d2b35996e14dafdd5a62fb079","private_key":"-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCoP/kianzCBmDE\n3N3oTX++NZ+p75okY4RHODJt0198INeMLMw1eApm7Xa87EPw76/shmQ/eAmZyYZq\nf7EU+3zMbtgL98eWQorPIer8qpklHEhwDgeOVkZmrzhqJB5Q2muB3nonS1AJuxiZ\nTYeq9FclNrulBRbmIEaCq9VkgzLtedR79uwGoFRNoIaUtzG1S1Q9pfpbgQeJMhm2\nLyHNh/x1sgrJEvet0Bfi7CHwzVB5iUF0sNBocjSLKLy/I/80jIjik90UKEzWgcvI\nVC2IFYDA2XFS9bJ4Pdfveb4mgvKkHzf5ljqw0hpvo+VT/01hY61Esj1wGrj9pJBD\nmYBSSq2ZAgMBAAECggEAC2ZJOqEZKpq8xf3afa25juFKe/y3VomVGe+3b/xDMxF1\nFULoQ6OqXcKvWbnO2SVeR7Hr2yaGjQBL3o2gCYZIFIBanEX5pIdF6SaYya2D4pEt\n4cS7k5PqIXU0BvIDSVJhOBuDLoQibERcVG+9tlInkOaKVHIZtPYhHOOoWc7vXYpY\nX4DuvB7eJphyqmHgTID6nNkaklsoFyIu6QO8DhgEkP33i6d/DhFTKZjZedNJDjg5\n3obpj4c8Poan9lH+TpM+ase6LZhNSdfgfn3SQRqa/Yn/8yY0TXPs6kZ7LcFCyoVD\nwxYc4ZGqSzoveYFs95v7TRUFJqwTttirWHGmBXGz0QKBgQDT3UvalkS6Kw3GPkWP\nIfz8b6/zwAoEPK3xcF3vjnvtOKkWH78kM+ZQXPU+SveQFjzWpIsG+WyMlBka0eNf\nOJrn/D9iTLog5G8HMEEIvCY7cz3wcsLRE/613EJs7+efsvIUNPoomquqOSbgQxIV\nWm84sevo2YL+FRLNZY3Ba5IeaQKBgQDLTLgDB6PY1abKz7qBRCeDqqpAyAC/nLlt\nDF1yc9pU+7oTy03cgnW/QS8W3LobTljbn/+dm0hJeo0bd6hg0lKk6ZQ9IS63koEY\njvntl1d+i0ZdhNFBY4qoni4AcyNwh9O5vvPVoIkph4578T62b6QSKAbHrlNGIx2D\n0UiJDi+PsQKBgQCTSKyK8RwmL/gLcQ76Si6NbzdqxH4yI9zok6059FvCtjkV4EwI\n5uudwoHbJFKmIE97CDh+SLdloy8wrejbMYa+72VA+QYMB8IHxUvwvpv1iE/u8Fju\n8G+KDe0/vifPpZ8U3R9rSts8Iy8biITxw0S+rTHLViryZ8QCdi7t39JcwQKBgFcR\nkG2bxAyF1F1gAhyCt/moCiqcfdWSpceSWCNAgu2KsfLwS3R5WzyCCkzcU8iGEYBe\nUfeKHbd6iRyObsqoyURf1WEo6P0t/aQq99dNzecgdw5uZ8B9hVEaDdGbfj4frgoL\nQhroGlZy/A8RDy7LOZWdFupGOtv7BhUCePJZ5PzBAoGAdVFqyTPuSVfORrroDo/l\nrFhEhSazjClTmGwYyttNPv9YxKs0KPGsFVMIP871NRrJZ3BXFZQPZxCPfZOTLqKa\nlrRn5Y99LhKvt4Kh9v8+BiXVqOkd2Ffuxj4kxfQmEUYbZPC0IMQwP5wT68ppiEes\nX3kbVuv6TYgn/VSesgvlC2M=\n-----END PRIVATE KEY-----\n","client_email":"github-actions-service-account@rox-cloud.iam.gserviceaccount.com","client_id":"109181194157699132527","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/github-actions-service-account%40rox-cloud.iam.gserviceaccount.com"}'
        
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: gcr.io
          username: _json_key
          password: '{"type":"service_account","project_id":"rox-cloud","private_key_id":"25c1a623b5af1f1d2b35996e14dafdd5a62fb079","private_key":"-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCoP/kianzCBmDE\n3N3oTX++NZ+p75okY4RHODJt0198INeMLMw1eApm7Xa87EPw76/shmQ/eAmZyYZq\nf7EU+3zMbtgL98eWQorPIer8qpklHEhwDgeOVkZmrzhqJB5Q2muB3nonS1AJuxiZ\nTYeq9FclNrulBRbmIEaCq9VkgzLtedR79uwGoFRNoIaUtzG1S1Q9pfpbgQeJMhm2\nLyHNh/x1sgrJEvet0Bfi7CHwzVB5iUF0sNBocjSLKLy/I/80jIjik90UKEzWgcvI\nVC2IFYDA2XFS9bJ4Pdfveb4mgvKkHzf5ljqw0hpvo+VT/01hY61Esj1wGrj9pJBD\nmYBSSq2ZAgMBAAECggEAC2ZJOqEZKpq8xf3afa25juFKe/y3VomVGe+3b/xDMxF1\nFULoQ6OqXcKvWbnO2SVeR7Hr2yaGjQBL3o2gCYZIFIBanEX5pIdF6SaYya2D4pEt\n4cS7k5PqIXU0BvIDSVJhOBuDLoQibERcVG+9tlInkOaKVHIZtPYhHOOoWc7vXYpY\nX4DuvB7eJphyqmHgTID6nNkaklsoFyIu6QO8DhgEkP33i6d/DhFTKZjZedNJDjg5\n3obpj4c8Poan9lH+TpM+ase6LZhNSdfgfn3SQRqa/Yn/8yY0TXPs6kZ7LcFCyoVD\nwxYc4ZGqSzoveYFs95v7TRUFJqwTttirWHGmBXGz0QKBgQDT3UvalkS6Kw3GPkWP\nIfz8b6/zwAoEPK3xcF3vjnvtOKkWH78kM+ZQXPU+SveQFjzWpIsG+WyMlBka0eNf\nOJrn/D9iTLog5G8HMEEIvCY7cz3wcsLRE/613EJs7+efsvIUNPoomquqOSbgQxIV\nWm84sevo2YL+FRLNZY3Ba5IeaQKBgQDLTLgDB6PY1abKz7qBRCeDqqpAyAC/nLlt\nDF1yc9pU+7oTy03cgnW/QS8W3LobTljbn/+dm0hJeo0bd6hg0lKk6ZQ9IS63koEY\njvntl1d+i0ZdhNFBY4qoni4AcyNwh9O5vvPVoIkph4578T62b6QSKAbHrlNGIx2D\n0UiJDi+PsQKBgQCTSKyK8RwmL/gLcQ76Si6NbzdqxH4yI9zok6059FvCtjkV4EwI\n5uudwoHbJFKmIE97CDh+SLdloy8wrejbMYa+72VA+QYMB8IHxUvwvpv1iE/u8Fju\n8G+KDe0/vifPpZ8U3R9rSts8Iy8biITxw0S+rTHLViryZ8QCdi7t39JcwQKBgFcR\nkG2bxAyF1F1gAhyCt/moCiqcfdWSpceSWCNAgu2KsfLwS3R5WzyCCkzcU8iGEYBe\nUfeKHbd6iRyObsqoyURf1WEo6P0t/aQq99dNzecgdw5uZ8B9hVEaDdGbfj4frgoL\nQhroGlZy/A8RDy7LOZWdFupGOtv7BhUCePJZ5PzBAoGAdVFqyTPuSVfORrroDo/l\nrFhEhSazjClTmGwYyttNPv9YxKs0KPGsFVMIP871NRrJZ3BXFZQPZxCPfZOTLqKa\nlrRn5Y99LhKvt4Kh9v8+BiXVqOkd2Ffuxj4kxfQmEUYbZPC0IMQwP5wT68ppiEes\nX3kbVuv6TYgn/VSesgvlC2M=\n-----END PRIVATE KEY-----\n","client_email":"github-actions-service-account@rox-cloud.iam.gserviceaccount.com","client_id":"109181194157699132527","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/github-actions-service-account%40rox-cloud.iam.gserviceaccount.com"}'
          
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          push: true
          context: .
          tags: |
            gcr.io/rox-cloud/sc-go:latest
            gcr.io/rox-cloud/sc-go:${{ steps.short-sha.outputs.sha }}
